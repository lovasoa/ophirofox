name: Sign webextension

on:
  push:
    branches: master
    paths: [ "ophirofox/**", ".github/workflows/main.yml" ]
  workflow_dispatch: # Permet de lancer manuellement

defaults:
  run:
    working-directory: ./ophirofox

jobs:
  publish-to-amo:
    name: Build and publish the extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm install --global web-ext
      - id: version
        run: |
          ACTUAL_YEAR=$(date +%Y)
          YEAR=$(date +%y) # Deux derniers chiffres de l'année (25 pour 2025)
          
          # Ajout +1 à l'année courante seulement pour 2025
          if [ "$ACTUAL_YEAR" -eq 2025 ]; then
            YEAR=$((YEAR + 1))
          fi
          
          YEAR_MAJOR=$((YEAR / 10)) # Premier chiffre des deux derniers (2 pour 25)
          YEAR_MINOR=$((YEAR % 10)) # Dernier chiffre (5 pour 25)
          VERSION_BASE="${YEAR_MAJOR}.${YEAR_MINOR}"
          MONTH=$(date +%-m)
          DAY=$(date +%-d)
          HOUR=$(date +%-H)
          MINUTE=$(date +%-M)
          
          # For 2026 only: add 10000 to MMDD to ensure it's above all 2025 releases
          if [ "$ACTUAL_YEAR" -eq 2026 ]; then
            MMDD=$((MONTH * 100 + DAY + 10000))
          else
            MMDD=$((MONTH * 100 + DAY))
          fi

          # Format HHMM as integer to remove leading zeros
          HHMM=$((HOUR * 100 + MINUTE))
          
          # Version unlisted (self-hosted) : .HHMM pair
          HHMM_EVEN=$((HHMM - (HHMM % 2)))
          UNLISTED_VERSION="${VERSION_BASE}.${MMDD}.${HHMM_EVEN}"
          
          # Version listed (AMO) : .HHMM impair
          HHMM_ODD=$((HHMM_EVEN + 1))
          LISTED_VERSION="${VERSION_BASE}.${MMDD}.${HHMM_ODD}"
          
          echo "UNLISTED_VERSION=${UNLISTED_VERSION}" >> $GITHUB_ENV
          echo "LISTED_VERSION=${LISTED_VERSION}" >> $GITHUB_ENV
          echo "Generated versions - Unlisted: ${UNLISTED_VERSION}, Listed: ${LISTED_VERSION}"
          echo "Year: $ACTUAL_YEAR -> YEAR: $YEAR -> Version base: $VERSION_BASE, MMDD: $MMDD, HHMM: $HHMM"
      
      - run: web-ext lint --self-hosted --warnings-as-errors
      
      - name: Build and sign unlisted version (self-hosted)
        id: sign_unlisted
        run: |
          jq ".version |= \"$UNLISTED_VERSION\"" manifest.json > manifest.json.tmp && mv manifest.json.tmp manifest.json
          web-ext build
          web-ext sign --channel=unlisted --timeout=15000
        continue-on-error: true
        env:
          WEB_EXT_API_KEY: ${{ secrets.AMO_JWT_ISSUER }}
          WEB_EXT_API_SECRET: ${{ secrets.AMO_JWT_SECRET }}
      
      - name: Build and submit listed version (AMO, no wait)
        run: |
          jq ".version |= \"$LISTED_VERSION\" | del(.browser_specific_settings.gecko.update_url)" manifest.json > manifest.json.tmp && mv manifest.json.tmp manifest.json
          echo "AMO-compatible manifest created (without update_url)"
          web-ext build --overwrite-dest
          web-ext sign --channel=listed --timeout=15000
        continue-on-error: true
        env:
          WEB_EXT_API_KEY: ${{ secrets.AMO_JWT_ISSUER }}
          WEB_EXT_API_SECRET: ${{ secrets.AMO_JWT_SECRET }}
      
      - run: ls -lah ./web-ext-artifacts
      
      - name: Copy signed XPI if available
        run: |
          if ls ./web-ext-artifacts/*xpi 1> /dev/null 2>&1; then
            cp ./web-ext-artifacts/*xpi ../ophirofox.xpi
          else
            echo "No signed XPI found, using unsigned build"
            # Get the most recent zip file
            cp $(ls -t ./web-ext-artifacts/*.zip | head -1) ../ophirofox.xpi
          fi
      
      - name: Create the mobile version (with all permissions asked on installation and no optional permissions)
        run: |
          # Restore unlisted version for mobile build
          jq ".version |= \"$UNLISTED_VERSION\"" manifest.json > manifest.json.tmp && mv manifest.json.tmp manifest.json
          jq '.permissions += .optional_permissions | .optional_permissions = []' manifest.json > manifest.mobile.json
          mv manifest.mobile.json manifest.json
          web-ext build --overwrite-dest
          cp $(ls -t ./web-ext-artifacts/*.zip | head -1) ../ophirofox.mobile.zip
      
      - run: node ../update-manifest.js | tee /tmp/update_manifest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Determine release tag and prerelease status
        run: |
          if [ "${{ steps.sign_unlisted.outcome }}" == "success" ]; then
            echo "RELEASE_TAG=v${{ env.UNLISTED_VERSION }}" >> $GITHUB_ENV
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
          else
            echo "RELEASE_TAG=v${{ env.UNLISTED_VERSION }}-unsigned" >> $GITHUB_ENV
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
          fi
      
      - name: Delete old unsigned prereleases (if this release is signed)
        if: steps.sign_unlisted.outcome == 'success'
        run: |
          gh release list --limit 100 | grep 'Pre-release' | grep 'unsigned' | grep -v 'current' | while read -r line; do
            tag=$(echo "$line" | awk '{print $1}')
            echo "Deleting unsigned prerelease: $tag"
            gh release delete "$tag" --yes || true
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Prepare release notes
        run: |
          git log -1 --pretty=%B > /tmp/changelog.txt
          if [ "${{ steps.sign_unlisted.outcome }}" != "success" ]; then
            echo "" >> /tmp/changelog.txt
            echo "⚠️ **Note:** This release is not signed by Mozilla due to a signing service timeout." >> /tmp/changelog.txt
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.UNLISTED_VERSION }}${{ env.IS_PRERELEASE == 'true' && ' (unsigned)' || '' }}
          draft: false
          prerelease: ${{ env.IS_PRERELEASE }}
          body_path: /tmp/changelog.txt
          files: |
            ophirofox.xpi
            ophirofox.mobile.zip
            /tmp/update_manifest.json
      
      - name: Update 'current' tag to always point to newest release (signed or unsigned)
        run: |
          cd ..
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -f current
          git push origin current --force
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create or update 'current' release with full details
        uses: softprops/action-gh-release@v1
        with:
          tag_name: current
          name: Current Build (v${{ env.UNLISTED_VERSION }})${{ env.IS_PRERELEASE == 'true' && ' - Unsigned' || ' - Signed' }}
          draft: false
          prerelease: true
          body_path: /tmp/changelog.txt
          files: |
            ophirofox.xpi
            ophirofox.mobile.zip
            /tmp/update_manifest.json
